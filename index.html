<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Top Albums of 2010</title>
	<link rel="stylesheet" href="stylesheets/screen.css" type="text/css" />
	<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.0/themes/redmond/jquery-ui.css" type="text/css" />
	<link rel="stylesheet" href="stylesheets/main.css" type="text/css" />
	<script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<script>
		google.load("jquery", "1.4.4");
		google.load("jqueryui", "1.8.7");
	</script>
	<script type="text/javascript" src="javascripts/lastfm.api.md5.js"></script>
	<script type="text/javascript" src="javascripts/lastfm.api.js"></script>
	<script type="text/javascript">
		var lastfm = new LastFM({
			apiKey    : 'a75a2bb78877595c7851f5f71672cff4',
			apiSecret : 'c8dc66d3c071fa4a90ce28bfe32db378'
		});

		$.YQL = function(query, callback) {
			if (!query || !callback) {
					throw new Error('$.YQL(): Parameters may be undefined');
			}
			var encodedQuery = encodeURIComponent(query.toLowerCase()),
					url = 'http://query.yahooapis.com/v1/public/yql?q='
							+ encodedQuery + '&format=json&callback=?';
				$.getJSON(url, callback);
		};


		var topAlbums = [];
		var albumList;
		var realUserName;
	
		var counter = 0;	
		function parseAlbums(list){
			var thisAlbum = list[counter];
			counter += 1;
			if (topAlbums.length >= 10 || thisAlbum === undefined){
				return;
			}
	
			// Try and Check for common fuckups in the naming
			thisAlbum.name = thisAlbum.name.replace("CD 1", "");
			thisAlbum.name = thisAlbum.name.replace("Deluxe Edition", "");
			thisAlbum.name = thisAlbum.name.replace("(Bonus Track Version)", "");
			thisAlbum.name = thisAlbum.name.replace(" EP", "");
			thisAlbum.name = thisAlbum.name.replace("[Explicit]", "");
			  
			

			lastfm.album.getInfo({album: thisAlbum.name, artist: thisAlbum.artist.name},
				{success: function(fmData){
					// Try and get the release date from the Last.FM data
					var trimmedDate = fmData.album.releasedate.replace(/^\s+|\s+$/g, '');
					if (trimmedDate != ""){
						if (fmData.album.releasedate.indexOf("2010") != -1){
							addAlbum(fmData);
						}
						parseAlbums(list);
					}
					// Snap, no release data. Lets get it from YQL/MusicBrains!
					else{
						query = "select * from xml where url='http://musicbrainz.org/ws/1/release/?type=xml&arist=";
						query+= escape(thisAlbum.artist.name)+"&title="+escape(thisAlbum.name) + "'";
						$.YQL(query,
							function(yqlData){
								// Very likely we get stuff undefined errors in here, so catch and continue if so
								try{	
									//console.log(yqlData.query.results.metadata['release-list']);
									// Find the relesase date if there are multiple releases objects
									var releaseDate;
									var releaseObject = yqlData.query.results.metadata['release-list'].release;
									if (releaseObject instanceof Array){
										var eventObject = releaseObject[0]['release-event-list'].event;
										if (eventObject instanceof Array){
											releaseDate = eventObject[0].date;
										}
										else{
											releaseDate = eventObject.date;
										}
									}
									// Or if there is only one release
									else{
										// Get the date if events is an array
										var eventObject = releaseObject['release-event-list'].event;
										if (eventObject instanceof Array){
											releaseDate = eventObject[0].date;
										}
										// Or if there is just one event
										else {
											releaseDate = eventObject.date;
										}
									}
									// Fucking finally. Should have the release date by now...
									if (releaseDate.indexOf("2010") != -1){
										addAlbum(fmData);
									}
								}
								catch (error){
									console.log("Oops, fucked up parsin a MusicBrainz results. Hope it's not from 2010. Here it is...");
									console.log(yqlData);
									console.log("PS: Artist: " + thisAlbum.artist.name + " - " + thisAlbum.name);
								}
								parseAlbums(list);
						});
					}
				}},
				{error: function(code, message){
					console.log("Error! Code: " + code + " Message: " + message);
				}});
		}

		var shownCounter = 0;	
		function addAlbum(thisAlbum){
			topAlbums.push(thisAlbum);
			
			if ($('#loading').is(":visible")){
				$('#loading').hide('blind');
			}
			results = $('#main');
			if (shownCounter == 0){
				results.append('<h1>' + realUserName + "'s Top Ten Albums of 2010</h1>");
				results.append("<div class='quiet'> According to Last.FM scrobbles</div><br/>");
				results.show('blind');
			}
			var newDiv = "<div id='result" + shownCounter + "'><img src='" + thisAlbum.album.image[3]["#text"] + "'><br/>";
			newDiv += "<h3>" + thisAlbum.album.artist + " - " + thisAlbum.album.name + '</h3></div>';
			results.append(newDiv);
			$('#result' + shownCounter).show('blind');
			shownCounter += 1;
		}

	  $(document).ready(function() {
			var userFail = $('#getUserFailure');
			$('#submitUser').click(function(){
				// If the failure message is showing, hide it
				if ($(userFail).is(":visible"))
					{$(userFail).hide('blind');}

				lastfm.user.getTopAlbums({user: $('#username').val(), period: '12month'}, {success: function(data){
					console.log(data);
					realUserName = data.topalbums['@attr'].user;
					if (data.topalbums.album == null){
						$(userFail).html("Sorry, that username appears to be invalid. Maybe you misspelled it?");
						$(userFail).show('blind');
					}
					// Looks like everything is fine. Throw up that loading screen...
					$('#getUser').hide('blind');
					$('#loading').show('blind');
					
					albumList = data.topalbums.album;
					parseAlbums(albumList);
				}, error: function(code, message){	
					$(userFail).html("Sorry, that username appears to be invalid. Maybe you misspelled it?");
					$(userFail).show('blind');
				}});
		})
	
 	});

		
	</script>
</head>

<body>
	<div class='container'>
		<div class='span-24' id='getUser'>	
				<div style='height:75px'></div>
				<h2>Last.FM Username:</h2>
				<input type='text' id='username'/><br/>
				<button id='submitUser'>Find my Top 10 Albums of 2010</button>
				<div id='getUserFailure'></div>
		</div>
		<div class='span-24 hidden' id='loading'>
			<div style='height:75px'></div>
			<img src="images/BRB-LOL-THIS-MUSIC-SUX.jpg" alt="BRB. LOL THIS MUSIC SUX"/>
		</div>
		<div class='span-24 hidden' id='main'>
		</div>
	</div>
</body>
</html>

